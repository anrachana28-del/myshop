<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Lookup</title>
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
h3 { text-align: center; margin-bottom: 20px; }
.order-card { background: #fff; padding: 15px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 700px; margin: 0 auto; }
.order-card ul { padding-left: 20px; }
.order-card li { margin-bottom: 4px; }
#searchResults { max-width: 700px; margin: 0 auto; }
</style>
</head>
<body>

<h3>Order Details</h3>
<div id="searchResults">Loading...</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAQMzAH4MJMojdHWAiLkYBSjdMJWS3Kccw",
  authDomain: "prewedding-f511a.firebaseapp.com",
  projectId: "prewedding-f511a",
  storageBucket: "prewedding-f511a.appspot.com",
  messagingSenderId: "1057725115554",
  appId: "1:1057725115554:web:4e8a48eaf959cbd9a07bfb"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Parse query params from URL
const urlParams = new URLSearchParams(window.location.search);
const searchCustomerID = urlParams.get('customerID');
const searchOrderCode = urlParams.get('orderCode');

// Fetch and display order
async function fetchOrder() {
  const container = document.getElementById('searchResults');
  if (!searchCustomerID || !searchOrderCode) {
    container.innerHTML = "<p>Please provide Customer ID and Order Code in URL.</p>";
    return;
  }

  try {
    const query = db.collectionGroup('orders')
      .where('customer.customID', '==', searchCustomerID)
      .where('orderCode', '==', searchOrderCode);

    const snap = await query.get();

    if (snap.empty) {
      container.innerHTML = "<p>No order found.</p>";
      return;
    }

    // Display all matching orders (usually 1)
    container.innerHTML = "";
    snap.forEach(doc => {
      const order = doc.data();
      const orderEl = document.createElement('div');
      orderEl.className = "order-card";

      orderEl.innerHTML = `
        <b>Order Code:</b> ${order.orderCode} <br>
        <b>Customer ID:</b> ${order.customer.customID} <br>
        <b>Name:</b> ${order.customer.name} <br>
        <b>Phone:</b> ${order.customer.phone} <br>
        <b>Address:</b> ${order.customer.address} <br>
        <b>Email:</b> ${order.customer.email || "N/A"} <br>
        <b>Total:</b> $${order.total.toFixed(2)} <br>
        <b>Products:</b>
        <ul>
          ${order.products.map(p => `<li>${p.name} x${p.qty} = $${(p.price*p.qty).toFixed(2)}</li>`).join('')}
        </ul>
        <small>Created at: ${order.createdAt?.toDate ? order.createdAt.toDate().toLocaleString() : "N/A"}</small>
      `;
      container.appendChild(orderEl);
    });

  } catch(err) {
    console.error(err);
    container.innerHTML = "<p>Error fetching order.</p>";
  }
}

// Run on page load
window.addEventListener('DOMContentLoaded', fetchOrder);
</script>

</body>
</html>
